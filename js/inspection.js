// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
let currentTab = 'vehicle';
let currentRecordId = null;
let inspectionData = {};
let photosData = {};

// „Éû„Éº„ÇØÂÆöÁæ©ÔºàË®òÂè∑„Å®Êó•Êú¨Ë™ûË™¨ÊòéÔºâ
const markDefinitions = {
    '‚úì': 'ÁÇπÊ§úËâØÂ•Ω',
    '√ó': '‰∫§Êèõ',
    'A': 'Ë™øÊï¥',
    'C': 'Ê∏ÖÊéÉ',
    'P': 'ÁúÅÁï•',
    '‚óã': 'ÁâπÂÆöÊï¥ÂÇô',
    '‚ñ≥': '‰øÆÁêÜ',
    'T': 'Á∑†‰ªò',
    'L': 'Áµ¶Ê≤π(Ê∞¥)',
    '/': 'Ë©≤ÂΩì„Å™„Åó'
};

// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', () => {
    // URL„Éë„É©„É°„Éº„Çø„Åã„Çâ„É¨„Ç≥„Éº„ÉâID„ÇíÂèñÂæó
    const urlParams = new URLSearchParams(window.location.search);
    currentRecordId = urlParams.get('id');

    // Êó•‰ªò„ÇíË®≠ÂÆö
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('inspection-date').value = today;
    document.getElementById('completion-date').value = today;

    // ÁÇπÊ§úÈ†ÖÁõÆ„ÇíÊèèÁîª
    renderInspectionItems();
    renderReplacementParts();
    renderMeasurements();
    renderCustomInspectionItems();

    // „Çø„ÉñÂàá„ÇäÊõø„Åà„Ç§„Éô„É≥„Éà
    setupTabNavigation();

    // ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç§„Éô„É≥„Éà
    setupPhotoUpload();

    // Ëªä‰∏°Áï™Âè∑„ÅÆËá™ÂãïÊõ¥Êñ∞
    document.getElementById('registration-number')?.addEventListener('input', function() {
        const value = this.value || 'Êú™ÁôªÈå≤';
        document.getElementById('vehicle-display').textContent = value;
    });

    // Êï¥ÂÇôÊÉÖÂ†±„ÅÆËá™Âãï„Çµ„Éû„É™„ÉºÊõ¥Êñ∞
    setupSummaryAutoUpdate();

    // Êó¢Â≠ò„É¨„Ç≥„Éº„Éâ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË™≠„ÅøËæº„Åø„ÄÅ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
    if (currentRecordId) {
        loadRecord(currentRecordId);
    } else {
        // Êñ∞Ë¶è„É¨„Ç≥„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅ„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ
        inspectionData = {};
        photosData = {};
        clearAllCameraButtonBadges();
    }
});

// „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
function setupTabNavigation() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
}

// „Çø„ÉñÂàá„ÇäÊõø„Åà
function switchTab(tabName) {
    // „Çø„Éñ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');

    // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.querySelector(`.tab-content[data-content="${tabName}"]`).classList.add('active');

    // „Çø„Ç§„Éà„É´Êõ¥Êñ∞
    const titles = {
        vehicle: 'Ëªä‰∏°ÊÉÖÂ†±ÁôªÈå≤',
        engine: '„Ç®„É≥„Ç∏„É≥„Éª„É´„Éº„É†ÁÇπÊ§ú',
        interior: 'ÂÆ§ÂÜÖÁÇπÊ§ú',
        undercarriage: 'Ë∂≥Âªª„ÇäÁÇπÊ§ú',
        bottom: '‰∏ãÂªª„ÇäÁÇπÊ§ú',
        obd: 'ËªäËºâÂºèÊïÖÈöúË®∫Êñ≠Ë£ÖÁΩÆÁÇπÊ§ú',
        daily: 'Êó•Â∏∏ÁÇπÊ§ú',
        additional: 'ËøΩÂä†È†ÖÁõÆ'
    };
    document.getElementById('section-title').textContent = titles[tabName];

    currentTab = tabName;
}

// ÁÇπÊ§úÈ†ÖÁõÆ„ÇíÊèèÁîª
function renderInspectionItems() {
    ['engine', 'interior', 'undercarriage', 'bottom', 'obd', 'daily'].forEach(section => {
        const container = document.getElementById(`${section}-items`);
        if (!container) return;

        const items = inspectionItems[section];
        let html = '';

        items.forEach(group => {
            html += `
                <div class="inspection-card">
                    <div class="card-header">‚ñ† ${group.category}</div>
                    <div class="card-content">
                        ${group.items.map(item => `
                            <div class="inspection-item" data-item-id="${item.id}">
                                <div class="item-row">
                                    <div class="item-name ${item.required ? 'required' : ''}">${item.name}</div>
                                    <div class="item-actions">
                                        <select class="mark-select" data-item-id="${item.id}" onchange="selectMark('${item.id}', this.value)">
                                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                            ${Object.entries(markDefinitions).map(([code, description]) => `
                                                <option value="${code}">${code} - ${description}</option>
                                            `).join('')}
                                        </select>
                                        <button class="camera-btn" onclick="openPhotoModal('${item.id}', '${item.name}')">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    });
}

// ‰∫§ÊèõÈÉ®ÂìÅ„ÇíÊèèÁîª
function renderReplacementParts() {
    const container = document.getElementById('replacement-parts');
    if (!container) return;

    const html = replacementParts.map(part => `
        <div class="replacement-item" data-item-id="part_${part.id}">
            <label for="${part.id}" class="replacement-label">${part.name}</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="number" class="replacement-quantity" id="${part.id}" placeholder="${part.unit}" min="0" step="0.1" data-part-id="${part.id}" data-part-name="${part.name}" data-part-unit="${part.unit}">
                <button class="camera-btn" onclick="openPhotoModal('part_${part.id}', '${part.name}')" title="ÂÜôÁúüÊíÆÂΩ±">
                    <i class="fas fa-camera"></i>
                </button>
                ${part.custom ? `<button class="delete-part-btn" onclick="deleteCustomPart('${part.id}')" title="ÂâäÈô§"><i class="fas fa-trash"></i></button>` : ''}
            </div>
        </div>
    `).join('');

    container.innerHTML = html;
    
    // Êó¢Â≠ò„ÅÆÂÜôÁúü„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Ç´„É°„É©„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
    replacementParts.forEach(part => {
        const itemId = `part_${part.id}`;
        if (photosData[itemId] && photosData[itemId].length > 0) {
            updateCameraButton(itemId);
        }
    });
}

// Ê∏¨ÂÆöÂÄ§„ÇíÊèèÁîª
function renderMeasurements() {
    const container = document.getElementById('measurements');
    if (!container) return;

    const html = measurements.map(m => `
        <div class="measurement-item">
            <label class="measurement-label">${m.name}</label>
            <input type="text" class="measurement-input" id="${m.id}" placeholder="${m.placeholder} ${m.unit}">
        </div>
    `).join('');

    container.innerHTML = html;
}

// „Éû„Éº„ÇØ„ÇíÈÅ∏ÊäûÔºà„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„ÇπÁî®Ôºâ
function selectMark(itemId, code) {
    const itemElement = document.querySelector(`.inspection-item[data-item-id="${itemId}"]`);
    if (!itemElement) return;

    if (code) {
        // ÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà
        itemElement.classList.add('checked');
        
        // „Éá„Éº„Çø„Çí‰øùÂ≠ò
        inspectionData[itemId] = {
            code: code,
            timestamp: new Date().toISOString()
        };
    } else {
        // „ÄåÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„Äç„Å´Êàª„Åï„Çå„ÅüÂ†¥Âêà
        itemElement.classList.remove('checked');
        delete inspectionData[itemId];
    }

    // ÈÄ≤Êçó„ÇíÊõ¥Êñ∞
    updateProgress();

    // ÊåØÂãï„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
    if ('vibrate' in navigator) {
        navigator.vibrate(10);
    }
}

// ÈÄ≤Êçó„ÇíÊõ¥Êñ∞
function updateProgress() {
    // ÂÆüÈöõ„ÅÆÈ†ÖÁõÆÊï∞„ÇíÂãïÁöÑ„Å´Ë®àÁÆó
    const sections = {
        engine: { total: inspectionItems.engine.reduce((sum, g) => sum + g.items.length, 0), checked: 0 },
        interior: { total: inspectionItems.interior.reduce((sum, g) => sum + g.items.length, 0), checked: 0 },
        undercarriage: { total: inspectionItems.undercarriage.reduce((sum, g) => sum + g.items.length, 0), checked: 0 },
        bottom: { total: inspectionItems.bottom.reduce((sum, g) => sum + g.items.length, 0), checked: 0 },
        obd: { total: inspectionItems.obd.reduce((sum, g) => sum + g.items.length, 0), checked: 0 },
        daily: { total: inspectionItems.daily.reduce((sum, g) => sum + g.items.length, 0), checked: 0 }
    };

    // „ÉÅ„Çß„ÉÉ„ÇØÊ∏à„ÅøÈ†ÖÁõÆ„Çí„Ç´„Ç¶„É≥„Éà
    Object.keys(inspectionData).forEach(itemId => {
        // ID„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Åã„Çâ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂà§ÂÆö
        let section = itemId.split('_')[0];
        // "under" „Çí "undercarriage" „Å´„Éû„ÉÉ„Éî„É≥„Ç∞
        if (section === 'under') {
            section = 'undercarriage';
        }
        if (sections[section]) {
            sections[section].checked++;
        }
    });

    // ÂÖ®‰Ωì„ÅÆÈÄ≤Êçó
    const totalItems = Object.values(sections).reduce((sum, s) => sum + s.total, 0);
    const checkedItems = Object.values(sections).reduce((sum, s) => sum + s.checked, 0);
    document.getElementById('progress-text').textContent = `${checkedItems} / ${totalItems} ÂÆå‰∫Ü`;

    // „Çø„Éñ„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
    Object.keys(sections).forEach(section => {
        const badge = document.querySelector(`.tab-btn[data-tab="${section}"] .tab-badge`);
        if (badge) {
            badge.textContent = `${sections[section].checked}/${sections[section].total}`;
        }
    });
}

// QR„Ç≥„Éº„Éâ„Çπ„Ç≠„É£„É≥
function scanQRCode() {
    showToast('üì∑ „Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...');

    setTimeout(() => {
        // „Éá„É¢Áî®Ôºö„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíËá™ÂãïÂÖ•Âäõ
        document.getElementById('registration-number').value = 'ÂõõË∞∑ 330 „Åõ 6098';
        document.getElementById('car-model').value = 'GAA-SNT33';
        document.getElementById('chassis-number').value = 'SNT33-028686';
        document.getElementById('engine-model').value = 'MA03';
        document.getElementById('first-registration').value = '‰ª§Âíå6Âπ¥3Êúà';
        document.getElementById('address').value = 'Êù±‰∫¨ÈÉΩÊñ∞ÂÆøÂå∫Ë•øÊñ∞ÂÆø2-8-1';
        document.getElementById('vehicle-display').textContent = 'ÂõõË∞∑ 330 „Åõ 6098';

        showToast('‚úÖ ËªäÊ§úË®ºÊÉÖÂ†±„ÇíË™≠„ÅøÂèñ„Çä„Åæ„Åó„Åü');
    }, 1500);
}

// ÂÜôÁúü„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
let currentPhotoItemId = null;
let currentPhotoItemName = null;

function openPhotoModal(itemId, itemName) {
    currentPhotoItemId = itemId;
    currentPhotoItemName = itemName;

    document.getElementById('photoModalTitle').textContent = `ÂÜôÁúüÁÆ°ÁêÜ - ${itemName}`;
    document.getElementById('photoModal').classList.add('show');

    // Êó¢Â≠ò„ÅÆÂÜôÁúü„ÇíË°®Á§∫
    renderPhotoGallery();
}

function closePhotoModal() {
    document.getElementById('photoModal').classList.remove('show');
    currentPhotoItemId = null;
    currentPhotoItemName = null;
}

// ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâË®≠ÂÆö
function setupPhotoUpload() {
    const input = document.getElementById('photoInput');
    if (!input) return;

    input.addEventListener('change', function(e) {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(event) {
                // ÂÜôÁúü„ÇíÂúßÁ∏Æ„Åó„Å¶„Åã„ÇâËøΩÂä†
                compressAndAddPhoto(currentPhotoItemId, event.target.result);
            };
            reader.readAsDataURL(file);
        });

        // ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
        e.target.value = '';
    });
}

// ÂÜôÁúü„ÇíÂúßÁ∏Æ„Åó„Å¶„Åã„ÇâËøΩÂä†
function compressAndAddPhoto(itemId, dataUrl) {
    const img = new Image();
    img.src = dataUrl;
    
    img.onload = function() {
        const canvas = document.createElement('canvas');
        
        // „Çà„ÇäÂ∞è„Åï„ÅÑ„Çµ„Ç§„Ç∫„Å´Â§âÊõ¥ÔºàLocalStorageÂÆπÈáèÂØæÁ≠ñÔºâ
        const maxWidth = 800;   // 1280 ‚Üí 800„Å´Â§âÊõ¥
        const maxHeight = 800;  // 1280 ‚Üí 800„Å´Â§âÊõ¥
        
        let width = img.width;
        let height = img.height;
        
        // „Çµ„Ç§„Ç∫Ë™øÊï¥
        if (width > maxWidth || height > maxHeight) {
            if (width > height) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
            } else {
                width = Math.round((width * maxHeight) / height);
                height = maxHeight;
            }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // JPEGÂìÅË≥™„Çí„Åï„Çâ„Å´‰∏ã„Åí„ÇãÔºà70% ‚Üí 60%Ôºâ
        let compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6);
        
        // „Åù„Çå„Åß„ÇÇÂ§ß„Åç„Åô„Åé„ÇãÂ†¥Âêà„ÅØ„Åï„Çâ„Å´ÂúßÁ∏Æ
        if (compressedDataUrl.length > 200000) { // 200KB‰ª•‰∏ä„ÅÆÂ†¥Âêà
            compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5); // ÂìÅË≥™50%
        }
        if (compressedDataUrl.length > 300000) { // 300KB‰ª•‰∏ä„ÅÆÂ†¥Âêà
            compressedDataUrl = canvas.toDataURL('image/jpeg', 0.4); // ÂìÅË≥™40%
        }
        
        // ÂúßÁ∏ÆÂæå„ÅÆÂÜôÁúü„ÇíËøΩÂä†
        addPhoto(itemId, compressedDataUrl);
        
        // ÂúßÁ∏ÆÁéá„Çí„É≠„Ç∞Âá∫Âäõ
        const originalSize = (dataUrl.length / 1024).toFixed(2);
        const compressedSize = (compressedDataUrl.length / 1024).toFixed(2);
        const compressionRate = ((1 - compressedDataUrl.length / dataUrl.length) * 100).toFixed(1);
        console.log(`ÂÜôÁúüÂúßÁ∏Æ: ${originalSize}KB ‚Üí ${compressedSize}KB (${compressionRate}%ÂâäÊ∏õ)`);
    };
    
    img.onerror = function() {
        console.error('ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        showToast('‚ùå ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    };
}

// ÂÜôÁúü„ÇíËøΩÂä†
function addPhoto(itemId, dataUrl) {
    if (!photosData[itemId]) {
        photosData[itemId] = [];
    }

    const photoId = generateUUID();
    photosData[itemId].push({
        id: photoId,
        url: dataUrl,
        beforeAfter: 'before',
        timestamp: new Date().toISOString()
    });

    // „Ç´„É°„É©„Éú„Çø„É≥„Å´„Éê„ÉÉ„Ç∏„ÇíËøΩÂä†
    updateCameraButton(itemId);

    // „ÇÆ„É£„É©„É™„Éº„ÇíÊõ¥Êñ∞
    renderPhotoGallery();

    showToast('‚úÖ ÂÜôÁúü„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
}

// ÂÜôÁúü„ÇÆ„É£„É©„É™„Éº„ÇíÊèèÁîª
function renderPhotoGallery() {
    const container = document.getElementById('photoGallery');
    if (!container || !currentPhotoItemId) return;

    const photos = photosData[currentPhotoItemId] || [];

    if (photos.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">ÂÜôÁúü„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        return;
    }

    const html = photos.map(photo => `
        <div class="photo-item">
            <img src="${photo.url}" alt="ÁÇπÊ§úÂÜôÁúü">
            <span class="photo-badge ${photo.beforeAfter}">${photo.beforeAfter === 'before' ? 'Ââç' : 'Âæå'}</span>
            <button class="photo-delete" onclick="deletePhoto('${currentPhotoItemId}', '${photo.id}')">
                <i class="fas fa-times"></i>
            </button>
            <div class="photo-controls">
                <button class="photo-control-btn" onclick="toggleBeforeAfter('${currentPhotoItemId}', '${photo.id}')">
                    ${photo.beforeAfter === 'before' ? 'Âæå„Å´Â§âÊõ¥' : 'Ââç„Å´Â§âÊõ¥'}
                </button>
            </div>
        </div>
    `).join('');

    container.innerHTML = html;
}

// ÂÜôÁúü„ÇíÂâäÈô§
function deletePhoto(itemId, photoId) {
    if (!photosData[itemId]) return;

    photosData[itemId] = photosData[itemId].filter(p => p.id !== photoId);

    updateCameraButton(itemId);
    renderPhotoGallery();
    showToast('üóëÔ∏è ÂÜôÁúü„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
}

// Before/After„ÇíÂàá„ÇäÊõø„Åà
function toggleBeforeAfter(itemId, photoId) {
    const photo = photosData[itemId]?.find(p => p.id === photoId);
    if (!photo) return;

    photo.beforeAfter = photo.beforeAfter === 'before' ? 'after' : 'before';
    renderPhotoGallery();
}



// „Ç´„É°„É©„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
function updateCameraButton(itemId) {
    const button = document.querySelector(`[data-item-id="${itemId}"] .camera-btn`);
    if (!button) return;

    const hasPhotos = photosData[itemId] && photosData[itemId].length > 0;
    if (hasPhotos) {
        button.classList.add('has-photos');
    } else {
        button.classList.remove('has-photos');
    }
}

// „Åô„Åπ„Å¶„ÅÆ„Ç´„É°„É©„Éú„Çø„É≥„ÅÆ„Éê„ÉÉ„Ç∏„Çí„ÇØ„É™„Ç¢
function clearAllCameraButtonBadges() {
    document.querySelectorAll('.camera-btn').forEach(button => {
        button.classList.remove('has-photos');
    });
}

// LocalStorage„ÅÆ‰ΩøÁî®Áä∂Ê≥Å„Çí„ÉÅ„Çß„ÉÉ„ÇØ
function checkLocalStorageCapacity() {
    try {
        let totalSize = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length + key.length;
            }
        }
        
        const totalSizeKB = (totalSize / 1024).toFixed(2);
        const limitKB = 5120; // Á¥Ñ5MB
        const usagePercent = ((totalSize / 1024 / limitKB) * 100).toFixed(1);
        
        console.log(`LocalStorage‰ΩøÁî®Èáè: ${totalSizeKB}KB / ${limitKB}KB (${usagePercent}%)`);
        
        if (totalSize / 1024 > limitKB * 0.8) { // 80%‰ª•‰∏ä‰ΩøÁî®
            showToast(`‚ö†Ô∏è LocalStorageÂÆπÈáè„Åå ${usagePercent}% ‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`, 'warning');
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('ÂÆπÈáè„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
        return true;
    }
}

// ‰∏ãÊõ∏„Åç‰øùÂ≠ò
async function saveAsDraft() {
    try {
        // LocalStorageÂÆπÈáè„ÉÅ„Çß„ÉÉ„ÇØ
        checkLocalStorageCapacity();
        
        const data = collectFormData();
        data.status = 'draft';

        if (currentRecordId) {
            // Êõ¥Êñ∞
            await updateRecord(currentRecordId, data);
            showToast('‚úÖ ‰∏ãÊõ∏„Åç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        } else {
            // Êñ∞Ë¶è‰ΩúÊàê
            const record = await createRecord(data);
            currentRecordId = record.id;
            showToast('‚úÖ ‰∏ãÊõ∏„Åç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            // URL„ÇíÊõ¥Êñ∞
            history.replaceState(null, '', `?id=${currentRecordId}`);
        }
    } catch (error) {
        console.error('‰∏ãÊõ∏„Åç‰øùÂ≠ò„Ç®„É©„Éº:', error);
        // „Ç®„É©„Éº„ÅÆË©≥Á¥∞„Çí„Éà„Éº„Çπ„Éà„ÅßË°®Á§∫
        const errorMsg = error.message || error.toString();
        showToast(`‚ùå ‰∏ãÊõ∏„Åç‰øùÂ≠ò„Å´Â§±Êïó: ${errorMsg.substring(0, 50)}`);
    }
}

// ÁÇπÊ§úÂÆå‰∫Ü
async function completeInspection() {
    // ÂøÖÈ†àÈ†ÖÁõÆ„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
    const requiredFields = [
        { id: 'client-name', name: '‰æùÈ†ºËÄÖ„ÅÆÊ∞èÂêçÂèà„ÅØÂêçÁß∞' },
        { id: 'registration-number', name: 'Ëá™ÂãïËªäÁôªÈå≤Áï™Âè∑' },
        { id: 'total-mileage', name: 'ÁÇπÊ§ú(Êï¥ÂÇô)ÊôÇ„ÅÆÁ∑èËµ∞Ë°åË∑ùÈõ¢' },
        { id: 'inspection-date', name: 'ÁÇπÊ§ú„ÅÆÂπ¥ÊúàÊó•' }
    ];

    for (const field of requiredFields) {
        const value = document.getElementById(field.id)?.value;
        if (!value || value.trim() === '') {
            showToast(`‚ùå ${field.name}„ÅØÂøÖÈ†àÈ†ÖÁõÆ„Åß„Åô`);
            return;
        }
    }

    try {
        const data = collectFormData();
        data.status = 'completed';
        data.access_token = generateAccessToken();
        data.qr_code = `${window.location.origin}/customer.html?token=${data.access_token}`;

        if (currentRecordId) {
            await updateRecord(currentRecordId, data);
        } else {
            const record = await createRecord(data);
            currentRecordId = record.id;
        }

        // Êó¢Â≠ò„ÅÆÂÜôÁúü„ÇíÂâäÈô§„Åó„Å¶„Åã„ÇâÊñ∞„Åó„ÅÑÂÜôÁúü„Çí‰øùÂ≠ò
        await deleteExistingPhotos(currentRecordId);
        await savePhotos();

        showToast('‚úÖ Êï¥ÂÇôË®òÈå≤„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');

        // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        if (confirm('Êï¥ÂÇôË®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ\nÂ∏≥Á•®„ÇíÂá∫Âäõ„Åó„Åæ„Åô„Åã?')) {
            // PDFÂá∫Âäõ„Éö„Éº„Ç∏„Å´ÈÅ∑Áßª
            window.location.href = `pdf-output.html?id=${currentRecordId}`;
        } else {
            // Ê§úÁ¥¢„Éö„Éº„Ç∏„Å´Êàª„Çã
            setTimeout(() => {
                window.location.href = 'search.html';
            }, 1000);
        }
    } catch (error) {
        console.error('ÂÆå‰∫Ü‰øùÂ≠ò„Ç®„É©„Éº:', error);
        // „Ç®„É©„Éº„ÅÆË©≥Á¥∞„Çí„Éà„Éº„Çπ„Éà„ÅßË°®Á§∫
        const errorMsg = error.message || error.toString();
        showToast(`‚ùå ‰øùÂ≠ò„Å´Â§±Êïó: ${errorMsg.substring(0, 50)}`);
    }
}

// „Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÇíÂèéÈõÜ
function collectFormData() {
    // Ëªä‰∏°ÊÉÖÂ†±
    const vehicleData = {
        client_name: document.getElementById('client-name')?.value || '',
        registration_number: document.getElementById('registration-number')?.value || '',
        car_model: document.getElementById('car-model')?.value || '',
        chassis_number: document.getElementById('chassis-number')?.value || '',
        engine_model: document.getElementById('engine-model')?.value || '',
        first_registration: document.getElementById('first-registration')?.value || '',
        address: document.getElementById('address')?.value || '',
        inspector_name: document.getElementById('inspector-name')?.value || '',
        workshop_address: document.getElementById('workshop-address')?.value || '',
        certification_number: document.getElementById('certification-number')?.value || '',
        inspection_date: document.getElementById('inspection-date')?.value || '',
        completion_date: document.getElementById('completion-date')?.value || '',
        chief_mechanic_name: document.getElementById('chief-mechanic-name')?.value || '',
        total_mileage: parseFloat(document.getElementById('total-mileage')?.value) || 0
    };

    // ÁÇπÊ§ú„Éá„Éº„Çø
    vehicleData.inspection_data = JSON.stringify(inspectionData);

    // ‰∫§ÊèõÈÉ®ÂìÅÔºàÊï∞Èáè„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„ÅÆ„ÅøÔºâ
    const parts = {};
    document.querySelectorAll('.replacement-quantity').forEach(input => {
        const partId = input.getAttribute('data-part-id');
        const quantity = input.value;
        if (quantity && parseFloat(quantity) > 0) {
            const partName = input.getAttribute('data-part-name') || '';
            const unit = input.getAttribute('data-part-unit') || '';
            parts[partName] = `${quantity} ${unit}`;
        }
    });
    vehicleData.replacement_parts = JSON.stringify(parts);
    
    // „Ç´„Çπ„Çø„É†ÈÉ®ÂìÅ„É™„Çπ„Éà„Çí‰øùÂ≠ò
    const customParts = replacementParts.filter(p => p.custom);
    vehicleData.custom_parts = JSON.stringify(customParts);

    // „Ç¢„Éâ„Éê„Ç§„Çπ
    vehicleData.advice = document.getElementById('advice')?.value || '';

    // Ê∏¨ÂÆöÂÄ§
    const measurementData = {};
    measurements.forEach(m => {
        const value = document.getElementById(m.id)?.value;
        if (value) {
            measurementData[m.name] = value;
        }
    });
    vehicleData.measurements = JSON.stringify(measurementData);

    // „Çø„Ç∞ÔºàJSONÊñáÂ≠óÂàó„Å®„Åó„Å¶‰øùÂ≠òÔºâ
    const tagsInput = document.getElementById('tags')?.value || '';
    const tagsArray = tagsInput.split(',').map(t => t.trim()).filter(t => t);
    vehicleData.tags = JSON.stringify(tagsArray);

    // „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„Çí‰øùÂ≠ò
    vehicleData.custom_inspection_items = JSON.stringify(customInspectionItems);

    return vehicleData;
}

// „É¨„Ç≥„Éº„Éâ„Çí‰ΩúÊàê
async function createRecord(data) {
    return await API.createRecord('maintenance_records', data);
}

// „É¨„Ç≥„Éº„Éâ„ÇíÊõ¥Êñ∞
async function updateRecord(id, data) {
    return await API.updateRecord('maintenance_records', id, data);
}

// „É¨„Ç≥„Éº„Éâ„ÇíË™≠„ÅøËæº„Åø
async function loadRecord(id) {
    try {
        const record = await API.getRecord('maintenance_records', id);

        // „Éï„Ç©„Éº„É†„Å´ÂÄ§„ÇíË®≠ÂÆö
        document.getElementById('client-name').value = record.client_name || '';
        document.getElementById('registration-number').value = record.registration_number || '';
        document.getElementById('car-model').value = record.car_model || '';
        document.getElementById('chassis-number').value = record.chassis_number || '';
        document.getElementById('engine-model').value = record.engine_model || '';
        document.getElementById('first-registration').value = record.first_registration || '';
        document.getElementById('address').value = record.address || '';
        document.getElementById('inspector-name').value = record.inspector_name || '';
        document.getElementById('workshop-address').value = record.workshop_address || '';
        document.getElementById('certification-number').value = record.certification_number || '';
        document.getElementById('inspection-date').value = record.inspection_date || '';
        document.getElementById('completion-date').value = record.completion_date || '';
        document.getElementById('chief-mechanic-name').value = record.chief_mechanic_name || '';
        document.getElementById('total-mileage').value = record.total_mileage || '';
        // „Çø„Ç∞„ÇíÂæ©ÂÖÉÔºàJSONÊñáÂ≠óÂàó„Åæ„Åü„ÅØÈÖçÂàó„Å´ÂØæÂøúÔºâ
        let tagsArray = [];
        if (record.tags) {
            try {
                tagsArray = typeof record.tags === 'string' ? JSON.parse(record.tags) : record.tags;
            } catch (e) {
                tagsArray = [];
            }
        }
        document.getElementById('tags').value = tagsArray.join(', ');
        document.getElementById('advice').value = record.advice || '';

        // Ëªä‰∏°Áï™Âè∑„ÇíË°®Á§∫
        document.getElementById('vehicle-display').textContent = record.registration_number || 'Êú™ÁôªÈå≤';

        // „Ç´„Çπ„Çø„É†ÈÉ®ÂìÅ„ÇíÂæ©ÂÖÉÔºàÁÇπÊ§ú„Éá„Éº„Çø„Çà„ÇäÂÖà„Å´Ôºâ
        if (record.custom_parts) {
            try {
                const customParts = JSON.parse(record.custom_parts);
                customParts.forEach(part => {
                    // Êó¢Â≠ò„ÅÆÈÉ®ÂìÅ„É™„Çπ„Éà„Å´Â≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
                    const exists = replacementParts.some(p => p.id === part.id);
                    if (!exists) {
                        replacementParts.push(part);
                    }
                });
                // ÈÉ®ÂìÅ„É™„Çπ„Éà„ÇíÂÜçÊèèÁîª
                renderReplacementParts();
            } catch (e) {
                console.error('„Ç´„Çπ„Çø„É†ÈÉ®ÂìÅ„ÅÆÂæ©ÂÖÉ„Ç®„É©„Éº:', e);
            }
        }

        // „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„ÇíÂæ©ÂÖÉÔºàÁÇπÊ§ú„Éá„Éº„Çø„Çà„ÇäÂÖà„Å´Ôºâ
        if (record.custom_inspection_items) {
            try {
                customInspectionItems = JSON.parse(record.custom_inspection_items);
                // „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„ÇíÊèèÁîª
                renderCustomInspectionItems();
            } catch (e) {
                console.error('„Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„ÅÆÂæ©ÂÖÉ„Ç®„É©„Éº:', e);
                customInspectionItems = [];
            }
        }

        // ÁÇπÊ§ú„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
        if (record.inspection_data) {
            inspectionData = JSON.parse(record.inspection_data);
            Object.keys(inspectionData).forEach(itemId => {
                const data = inspectionData[itemId];
                const itemElement = document.querySelector(`.inspection-item[data-item-id="${itemId}"]`);
                if (itemElement) {
                    // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂÄ§„ÇíË®≠ÂÆö
                    const select = itemElement.querySelector('.mark-select');
                    if (select) {
                        select.value = data.code;
                        itemElement.classList.add('checked');
                    }
                }
            });
        }

        // Ê∏¨ÂÆöÂÄ§„ÇíÂæ©ÂÖÉ
        if (record.measurements) {
            const measurementData = JSON.parse(record.measurements);
            Object.keys(measurementData).forEach(name => {
                const m = measurements.find(m => m.name === name);
                if (m) {
                    document.getElementById(m.id).value = measurementData[name];
                }
            });
        }

        // ‰∫§ÊèõÈÉ®ÂìÅ„ÇíÂæ©ÂÖÉ
        if (record.replacement_parts) {
            const parts = JSON.parse(record.replacement_parts);
            Object.keys(parts).forEach(partName => {
                const part = replacementParts.find(p => p.name === partName);
                if (part) {
                    // "Êï∞Èáè Âçò‰Ωç" ÂΩ¢Âºè„Åã„ÇâÊï∞Èáè„ÅÆ„Åø„ÇíÊäΩÂá∫
                    const quantityStr = parts[partName].toString();
                    const quantity = quantityStr.split(' ')[0];
                    const input = document.querySelector(`.replacement-quantity[data-part-id="${part.id}"]`);
                    if (input) {
                        input.value = quantity;
                    }
                }
            });
        }

        // ÂÜôÁúü„ÇíË™≠„ÅøËæº„Åø
        await loadPhotos(id);

        updateProgress();
        updateSummary(); // „Çµ„Éû„É™„Éº„ÇÇÊõ¥Êñ∞
        showToast('‚úÖ „É¨„Ç≥„Éº„Éâ„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
    } catch (error) {
        console.error('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        showToast('‚ùå „É¨„Ç≥„Éº„Éâ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
}

// ÂÜôÁúü„Çí‰øùÂ≠ò
async function savePhotos() {
    if (!currentRecordId) {
        console.warn('savePhotos: currentRecordId„ÅåÊú™Ë®≠ÂÆö');
        return;
    }

    console.log('ÂÜôÁúü‰øùÂ≠òÈñãÂßã:', { recordId: currentRecordId, photosCount: Object.keys(photosData).length });

    for (const itemId of Object.keys(photosData)) {
        const photos = photosData[itemId];
        
        // itemId„Åã„ÇâÈ†ÖÁõÆÂêç„ÇíÂèñÂæó
        const itemName = getItemNameById(itemId);
        console.log('È†ÖÁõÆÂÜôÁúü‰øùÂ≠ò:', { itemId, itemName, photoCount: photos.length });
        
        for (const photo of photos) {
            const photoData = {
                record_id: currentRecordId,
                item_id: itemId,
                item_name: itemName,
                photo_url: photo.url,
                thumbnail_url: photo.url, // ÂÆüË£Ö„Åß„ÅØÂúßÁ∏ÆÁâà„Çí‰ΩúÊàê
                before_after: photo.beforeAfter,
                is_cover: false,
                caption: '',
                photographer: document.getElementById('mechanic-name')?.value || '',
                photo_date: photo.timestamp,
                sort_order: photos.indexOf(photo)
            };

            try {
                await API.createRecord('inspection_photos', photoData);
                console.log('ÂÜôÁúü‰øùÂ≠òÊàêÂäü:', { itemId, itemName });
            } catch (error) {
                console.error('ÂÜôÁúü‰øùÂ≠ò„Ç®„É©„Éº:', { itemId, itemName, error });
                throw error; // „Ç®„É©„Éº„ÇíÂÜç„Çπ„É≠„Éº
            }
        }
    }
    
    console.log('ÂÜôÁúü‰øùÂ≠òÂÆå‰∫Ü');
}

// itemId„Åã„ÇâÈ†ÖÁõÆÂêç„ÇíÂèñÂæó
function getItemNameById(itemId) {
    // ÂÖ®‰ΩìÂÜôÁúü„ÅÆÂ†¥Âêà
    if (itemId === 'parts_overall') {
        return '‰∫§ÊèõÈÉ®ÂìÅÂÖ®‰Ωì';
    }
    
    // ÁÇπÊ§úÈ†ÖÁõÆ„ÇíÊ§úÁ¥¢
    const sections = ['engine', 'interior', 'undercarriage', 'bottom', 'obd', 'daily'];
    
    for (const section of sections) {
        const items = inspectionItems[section];
        if (!items) continue;
        
        for (const group of items) {
            for (const item of group.items) {
                if (item.id === itemId) {
                    return item.name;
                }
            }
        }
    }
    
    // „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„ÇíÊ§úÁ¥¢
    const customItem = customInspectionItems.find(item => item.id === itemId);
    if (customItem) {
        return customItem.name;
    }
    
    // Ê®ôÊ∫ñ‰∫§ÊèõÈÉ®ÂìÅ„ÇíÊ§úÁ¥¢
    const standardPart = replacementParts.find(p => p.id === itemId);
    if (standardPart) {
        return standardPart.name;
    }
    
    // „Ç´„Çπ„Çø„É†ÈÉ®ÂìÅ„ÅÆÂ†¥ÂêàÔºàpart_„ÅßÂßã„Åæ„ÇãÔºâ
    if (itemId.startsWith('part_')) {
        const customPart = replacementParts.find(p => p.id === itemId);
        if (customPart) {
            return customPart.name;
        }
        // „Ç´„Çπ„Çø„É†ÈÉ®ÂìÅ„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØID„Åã„ÇâÊé®Ê∏¨
        return itemId.replace('part_', '');
    }
    
    return itemId; // Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØID„ÇíËøî„Åô
}

// Êó¢Â≠ò„ÅÆÂÜôÁúü„ÇíÂâäÈô§
async function deleteExistingPhotos(recordId) {
    try {
        const result = await API.getRecords('inspection_photos', { limit: 1000 });
        const allPhotos = result.data || [];
        
        // „Åì„ÅÆ„É¨„Ç≥„Éº„Éâ„ÅÆÂÜôÁúü„ÅÆ„Åø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        const photos = allPhotos.filter(photo => photo.record_id === recordId);
        
        for (const photo of photos) {
            try {
                await API.deleteRecord('inspection_photos', photo.id);
            } catch (error) {
                console.error('ÂÜôÁúüÂâäÈô§„Ç®„É©„Éº:', error);
            }
        }
    } catch (error) {
        console.error('Êó¢Â≠òÂÜôÁúü„ÅÆÂèñÂæó„Ç®„É©„Éº:', error);
    }
}

// ÂÜôÁúü„ÇíË™≠„ÅøËæº„Åø
async function loadPhotos(recordId) {
    try {
        const result = await API.getRecords('inspection_photos', { limit: 1000 });
        const allPhotos = result.data || [];
        
        // „Åì„ÅÆ„É¨„Ç≥„Éº„Éâ„ÅÆÂÜôÁúü„ÅÆ„Åø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        const photos = allPhotos.filter(photo => photo.record_id === recordId);

        // photosData„ÇíÂÆåÂÖ®„Å´„ÇØ„É™„Ç¢
        photosData = {};
        
        photos.forEach(photo => {
            if (!photosData[photo.item_id]) {
                photosData[photo.item_id] = [];
            }
            photosData[photo.item_id].push({
                id: photo.id,
                url: photo.photo_url,
                beforeAfter: photo.before_after,
                timestamp: photo.photo_date
            });

            // „Ç´„É°„É©„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            updateCameraButton(photo.item_id);
        });
    } catch (error) {
        console.error('ÂÜôÁúüË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        // „Ç®„É©„ÉºÊôÇ„ÇÇÂàùÊúüÂåñ
        photosData = {};
    }
}

// Ë®òÂè∑Ë™¨Êòé„Éë„Éç„É´„ÅÆÈñãÈñâ
// Ë®òÂè∑Ë™¨Êòé„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
function openLegendModal() {
    const modal = document.getElementById('legendModal');
    modal.style.display = 'flex';
}

// Ë®òÂè∑Ë™¨Êòé„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
function closeLegendModal() {
    const modal = document.getElementById('legendModal');
    modal.style.display = 'none';
}

// „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
window.addEventListener('click', function(event) {
    const legendModal = document.getElementById('legendModal');
    if (event.target === legendModal) {
        closeLegendModal();
    }
});

// „Éà„Éº„Çπ„ÉàÈÄöÁü•
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function generateAccessToken() {
    return Array.from({length: 32}, () => Math.floor(Math.random() * 36).toString(36)).join('');
}

// ÈÉ®ÂìÅËøΩÂä†„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
function showAddPartModal() {
    document.getElementById('addPartModal').classList.add('show');
    document.getElementById('newPartName').value = '';
    document.getElementById('newPartUnit').value = 'ÂÄã';
    setTimeout(() => {
        document.getElementById('newPartName').focus();
    }, 100);
}

// ÈÉ®ÂìÅËøΩÂä†„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
function closeAddPartModal() {
    document.getElementById('addPartModal').classList.remove('show');
}

// „Ç´„Çπ„Çø„É†ÈÉ®ÂìÅ„ÇíËøΩÂä†
function addCustomPart() {
    const name = document.getElementById('newPartName').value.trim();
    const unit = document.getElementById('newPartUnit').value;

    if (!name) {
        showToast('‚ùå ÈÉ®ÂìÅÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }

    // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
    const exists = replacementParts.some(p => p.name === name);
    if (exists) {
        showToast('‚ùå Âêå„ÅòÂêçÂâç„ÅÆÈÉ®ÂìÅ„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô');
        return;
    }

    // Êñ∞„Åó„ÅÑÈÉ®ÂìÅ„ÇíËøΩÂä†
    const partId = 'custom_' + Date.now();
    replacementParts.push({
        id: partId,
        name: name,
        unit: unit,
        custom: true
    });

    // ÂÜçÊèèÁîª
    renderReplacementParts();
    closeAddPartModal();
    showToast('‚úÖ ÈÉ®ÂìÅ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');

    // ËøΩÂä†„Åó„ÅüÈÉ®ÂìÅ„ÅÆÂÖ•ÂäõÊ¨Ñ„Å´„Éï„Ç©„Éº„Ç´„Çπ
    setTimeout(() => {
        const input = document.getElementById(partId);
        if (input) {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            input.focus();
        }
    }, 100);
}

// „Ç´„Çπ„Çø„É†ÈÉ®ÂìÅ„ÇíÂâäÈô§
function deleteCustomPart(partId) {
    if (!confirm('„Åì„ÅÆÈÉ®ÂìÅ„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
        return;
    }

    const index = replacementParts.findIndex(p => p.id === partId);
    if (index > -1) {
        replacementParts.splice(index, 1);
        renderReplacementParts();
        showToast('üóëÔ∏è ÈÉ®ÂìÅ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
    }
}

// „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„ÅÆÁÆ°ÁêÜ
let customInspectionItems = [];

// „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆËøΩÂä†„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
function showAddCustomItemModal() {
    document.getElementById('addCustomItemModal').classList.add('show');
    document.getElementById('newCustomItemName').value = '';
    setTimeout(() => {
        document.getElementById('newCustomItemName').focus();
    }, 100);
}

// „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆËøΩÂä†„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
function closeAddCustomItemModal() {
    document.getElementById('addCustomItemModal').classList.remove('show');
}

// „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„ÇíËøΩÂä†
function addCustomInspectionItem() {
    const name = document.getElementById('newCustomItemName').value.trim();

    if (!name) {
        showToast('‚ùå ÁÇπÊ§úÈ†ÖÁõÆÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }

    // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
    const exists = customInspectionItems.some(item => item.name === name);
    if (exists) {
        showToast('‚ùå Âêå„ÅòÂêçÂâç„ÅÆÁÇπÊ§úÈ†ÖÁõÆ„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô');
        return;
    }

    // Êñ∞„Åó„ÅÑÁÇπÊ§úÈ†ÖÁõÆ„ÇíËøΩÂä†
    const itemId = 'custom_item_' + Date.now();
    customInspectionItems.push({
        id: itemId,
        name: name,
        addedDate: Date.now()
    });

    // ÂÜçÊèèÁîª
    renderCustomInspectionItems();
    closeAddCustomItemModal();
    showToast('‚úÖ ÁÇπÊ§úÈ†ÖÁõÆ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');

    // ËøΩÂä†„Åó„ÅüÈ†ÖÁõÆ„Å´„Çπ„ÇØ„É≠„Éº„É´
    setTimeout(() => {
        const item = document.querySelector(`[data-item-id="${itemId}"]`);
        if (item) {
            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 100);
}

// „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„ÇíÂâäÈô§
function deleteCustomInspectionItem(itemId) {
    if (!confirm('„Åì„ÅÆÁÇπÊ§úÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
        return;
    }

    const index = customInspectionItems.findIndex(item => item.id === itemId);
    if (index > -1) {
        customInspectionItems.splice(index, 1);
        
        // ÁÇπÊ§ú„Éá„Éº„Çø„Åã„Çâ„ÇÇÂâäÈô§
        if (inspectionData[itemId]) {
            delete inspectionData[itemId];
        }
        
        // ÂÜôÁúü„Éá„Éº„Çø„Åã„Çâ„ÇÇÂâäÈô§
        if (photosData[itemId]) {
            delete photosData[itemId];
        }
        
        renderCustomInspectionItems();
        updateProgress();
        showToast('üóëÔ∏è ÁÇπÊ§úÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
    }
}

// „Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„ÇíÊèèÁîª
function renderCustomInspectionItems() {
    const container = document.getElementById('custom-inspection-items');
    if (!container) return;

    if (customInspectionItems.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">„Ç´„Çπ„Çø„É†ÁÇπÊ§úÈ†ÖÁõÆ„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        return;
    }

    const html = customInspectionItems.map(item => `
        <div class="inspection-item" data-item-id="${item.id}">
            <div class="item-row">
                <div class="item-name">${item.name}</div>
                <div class="item-actions">
                    <select class="mark-select" data-item-id="${item.id}" onchange="selectMark('${item.id}', this.value)">
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        ${Object.entries(markDefinitions).map(([code, description]) => `
                            <option value="${code}">${code} - ${description}</option>
                        `).join('')}
                    </select>
                    <button class="camera-btn" onclick="openPhotoModal('${item.id}', '${item.name}')">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="delete-item-btn" onclick="deleteCustomInspectionItem('${item.id}')" title="ÂâäÈô§">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');

    container.innerHTML = html;
    
    // Êó¢Â≠ò„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Å®ÂÜôÁúü„ÇíÂæ©ÂÖÉ
    customInspectionItems.forEach(item => {
        if (inspectionData[item.id]) {
            const data = inspectionData[item.id];
            const itemElement = document.querySelector(`.inspection-item[data-item-id="${item.id}"]`);
            if (itemElement) {
                const select = itemElement.querySelector('.mark-select');
                if (select) {
                    select.value = data.code || data;
                    itemElement.classList.add('checked');
                }
            }
        }
        
        if (photosData[item.id] && photosData[item.id].length > 0) {
            updateCameraButton(item.id);
        }
    });
}

// Êï¥ÂÇôÊÉÖÂ†±„Çµ„Éû„É™„Éº„ÅÆËá™ÂãïÊõ¥Êñ∞Ë®≠ÂÆö
function setupSummaryAutoUpdate() {
    const fields = [
        'inspector-name',
        'workshop-address',
        'certification-number',
        'inspection-date',
        'completion-date',
        'chief-mechanic-name',
        'total-mileage'
    ];

    fields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.addEventListener('input', updateSummary);
            element.addEventListener('change', updateSummary);
        }
    });

    // ÂàùÂõûÊõ¥Êñ∞
    updateSummary();
}

// Êï¥ÂÇôÊÉÖÂ†±„Çµ„Éû„É™„Éº„ÇíÊõ¥Êñ∞
function updateSummary() {
    const summaryFields = {
        'summary-inspector-name': document.getElementById('inspector-name')?.value || '-',
        'summary-workshop-address': document.getElementById('workshop-address')?.value || '-',
        'summary-certification-number': document.getElementById('certification-number')?.value || '-',
        'summary-inspection-date': document.getElementById('inspection-date')?.value || '-',
        'summary-completion-date': document.getElementById('completion-date')?.value || '-',
        'summary-chief-mechanic-name': document.getElementById('chief-mechanic-name')?.value || '-',
        'summary-total-mileage': document.getElementById('total-mileage')?.value 
            ? `${parseFloat(document.getElementById('total-mileage').value).toLocaleString()} km` 
            : '-'
    };

    Object.entries(summaryFields).forEach(([summaryId, value]) => {
        const element = document.getElementById(summaryId);
        if (element) {
            element.textContent = value;
        }
    });
}
