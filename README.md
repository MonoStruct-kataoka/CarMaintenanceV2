# 特定整備記録簿システム（PoC版）

国土交通省様式「特定整備記録簿（1年定期点検整備用）」をデジタル化し、スマホ・タブレット・PCで入力・閲覧・出力できるシステムです。

## 🎯 プロジェクト概要

### 目的
整備内容や交換部品の写真をQRコード付きA3モノクロ帳票として顧客に共有し、整備記録のデジタル管理を実現します。

### 対象ユーザー
- **整備士**: 点検入力・写真撮影・記録登録
- **フロント担当**: 顧客検索・帳票出力
- **顧客**: QRコード経由での整備内容閲覧

## ✨ 主な機能

### 1. 点検入力機能（inspection.html）
- 国土交通省様式準拠の点検項目入力
- 5つの点検区分
  - エンジンルーム点検
  - 室内点検
  - 足回り点検
  - 下回り点検
  - OBD（車載式故障診断装置）
- コード選択式入力（レ/×/A/C/P/○/△/T/L/）
- 各項目への写真撮影・紐付け機能（Before/After管理）
- 交換部品記録
  - 標準部品リスト搭載（エンジンオイル、オイルフィルタ等）
  - カスタム部品追加機能（名称・単位を任意設定可能）
  - 追加した部品の削除機能
- メンテナンスアドバイス記入
- 測定値入力（CO濃度、HC濃度、タイヤ溝、ブレーキパッド厚さ等）
- 下書き保存・完了機能

### 2. 写真管理機能
- カメラ起動またはアルバムから複数枚一括登録
- Before/After区分設定
- 削除機能
- サムネイル生成（PDF出力・一覧用）
- 点検項目ごとの紐付け管理

### 3. 検索・管理機能（search.html）
- 検索キー
  - 顧客名（部分一致）
  - 車両番号（部分一致）
  - 車台番号（部分一致）
  - ステータス（下書き/完了/アーカイブ）
- 整備記録一覧表示（タイムライン/テーブル切替）
- クリックで詳細表示ページに遷移（参照専用）

### 3.5. 詳細表示機能（view.html）【NEW】
- 整備記録の参照専用表示
- 全データの閲覧（車両情報、点検結果、写真等）
- 編集ボタンで編集画面に遷移
- PDF出力・削除操作

### 4. 帳票出力機能（pdf-output.html）
- A3モノクロPDF出力（国交省様式準拠）
- QRコード付き（顧客専用ページへのリンク）
- 出力オプション
  - QRコード含める/除く
  - 代表写真含める/除く
  - 凡例含める/除く
  - 測定値含める/除く

### 5. 顧客専用閲覧ページ（customer.html）
- QRコードでアクセス可能
- 車両情報表示
- 点検結果一覧
- 交換部品リスト
- 測定値表示
- 全写真ギャラリー（拡大表示対応）
- メンテナンスアドバイス表示

## 📁 ファイル構造

```
.
├── index.html                  # トップページ（メニュー）
├── inspection.html             # 点検入力画面
├── search.html                 # 検索・管理画面
├── view.html                   # 詳細表示画面（参照専用）
├── customer.html               # 顧客専用閲覧ページ
├── pdf-output.html            # PDF出力画面
├── test-multiple-records.html # 複数件登録テストページ
├── inspection-base.html       # 旧UI（参考用）
├── css/
│   ├── inspection.css         # 点検入力画面スタイル
│   └── view.css               # 詳細表示画面スタイル
├── js/
│   ├── api-helper.js          # API通信ヘルパー（フォールバック対応）
│   ├── inspection-data.js     # 点検項目データ定義
│   ├── inspection.js          # 点検入力ロジック
│   ├── search.js              # 検索・管理ロジック
│   ├── view.js                # 詳細表示ロジック
│   ├── customer.js            # 顧客ページロジック
│   └── pdf-output.js          # PDF出力ロジック
└── README.md                  # このファイル
```

## 🗄️ データベース構造

### テーブル: `maintenance_records`
整備記録のマスタ情報

| フィールド名 | 型 | 説明 |
|-------------|-----|------|
| id | text | レコードID（UUID） |
| client_name | text | 依頼者の氏名又は名称 |
| registration_number | text | 自動車登録番号 |
| car_model | text | 車名及び型式 |
| chassis_number | text | 車台番号 |
| engine_model | text | 原動機の型式 |
| first_registration | text | 初度登録年月 |
| mileage | number | 走行距離（km） |
| workshop_name | text | 事業場の名称・所在地 |
| inspection_date | text | 点検の年月日 |
| completion_date | text | 整備完了年月日 |
| mechanic_name | text | 整備責任者の氏名 |
| inspection_data | text | 点検データ（JSON） |
| replacement_parts | text | 交換部品情報（JSON） |
| custom_parts | text | カスタム追加部品定義（JSON） |
| advice | text | メンテナンスアドバイス |
| measurements | text | 測定値（JSON） |
| tags | text | タグ（JSON配列文字列） |
| qr_code | text | QRコードURL |
| access_token | text | 顧客アクセストークン |
| status | text | ステータス（draft/completed/archived） |

### テーブル: `inspection_photos`
点検写真の管理

| フィールド名 | 型 | 説明 |
|-------------|-----|------|
| id | text | 写真ID（UUID） |
| record_id | text | 整備記録ID |
| item_id | text | 点検項目ID |
| item_name | text | 点検項目名 |
| photo_url | text | 写真URL |
| thumbnail_url | text | サムネイルURL |
| before_after | text | 前後区分（before/after） |
| is_cover | bool | 代表写真かどうか |
| caption | text | キャプション |
| photographer | text | 撮影者 |
| photo_date | text | 撮影日時 |
| sort_order | number | 表示順序 |

## 🚀 使い方

### 1. 新規点検入力
1. トップページから「新規点検入力」をクリック
2. 車両情報を入力（QRコードスキャンでも可）
3. 各点検項目でコードを選択
4. 必要に応じて写真を撮影・添付
5. 交換部品・測定値・アドバイスを入力
   - **交換部品のカスタム追加**: 「追加項目」タブ → 「部品を追加」ボタン → 部品名と単位を入力
   - 追加した部品は削除アイコンで削除可能
6. 「下書き保存」または「完了」をクリック

### 2. 写真撮影・管理
1. 各点検項目の右側にあるカメラアイコンをクリック
2. 「写真を撮影 / アップロード」をクリック
3. カメラ起動またはファイル選択
4. Before/Afterを切り替え
5. 不要な写真は×ボタンで削除

### 3. 整備記録検索・閲覧
1. トップページから「整備記録検索」をクリック
2. 検索条件を入力（顧客名、車両番号等）
3. 「検索」をクリック
4. 一覧から記録をクリックして詳細表示
5. 詳細画面で「編集」ボタンをクリックして編集画面に遷移
   - または「PDF」ボタンでPDF出力
   - または「削除」ボタンで削除

### 4. PDF出力
1. 検索画面から対象記録のPDFアイコンをクリック
2. 出力オプションを選択
3. 「PDF出力」をクリック
4. ダウンロードされたPDFを印刷

### 5. 顧客への共有
1. 出力したPDFのQRコードを顧客に提示
2. 顧客がスマホでQRコードをスキャン
3. 専用ページで整備内容・全写真を閲覧可能

## 🔧 技術仕様

### フロントエンド
- HTML5 / CSS3 / JavaScript (ES6+)
- レスポンシブデザイン（モバイルファースト）
- Font Awesome（アイコン）
- jsPDF（PDF生成）
- QRCode.js（QRコード生成）

### バックエンド
- RESTful Table API
  - `GET /api/tables/{table}` - レコード一覧取得
  - `GET /api/tables/{table}/{id}` - 単一レコード取得
  - `POST /api/tables/{table}` - レコード作成
  - `PUT /api/tables/{table}/{id}` - レコード更新
  - `DELETE /api/tables/{table}/{id}` - レコード削除
- LocalStorageフォールバック（API利用不可時）

### データ形式
- JSON形式でのデータ交換
- Base64形式での画像保存（PoC版）
- LocalStorageによるオフライン動作サポート

## 📱 対応デバイス

- **PC**: Chrome, Firefox, Safari, Edge (最新版)
- **タブレット**: iPad, Android Tablet
- **スマホ**: iPhone (iOS 14+), Android (10+)

## ⚙️ 動作環境

- ブラウザのJavaScript有効化必須
- カメラ機能使用時はHTTPS環境推奨
- ローカルストレージ使用（写真保存用）

## 🎨 UI/UX特徴

- タブレット最適化レイアウト
- タップしやすい大きなボタン
- 進捗表示機能
- 記号説明パネル（常時参照可能）
- トースト通知でのフィードバック
- モーダルでの写真管理
- ライトボックスでの画像拡大表示

## 📋 点検コード体系

| コード | 意味 | 備考 |
|-------|------|------|
| ✓ | 点検良好 | - |
| × | 交換 | - |
| A | 調整 | - |
| C | 清掃 | - |
| P | 省略 | - |
| ○ | 特定整備 | - |
| △ | 修理 | - |
| T | 締付 | 他コードと併用可 |
| L | 給油（水） | 他コードと併用可 |
| / | 該当なし | - |

## 🔒 セキュリティ・プライバシー

- 顧客専用ページはランダムトークンでアクセス制御
- トークンは32文字のランダム文字列
- レコード削除時は論理削除（deleted=true）
- 写真データはBase64エンコードで保存

## 🚧 現在実装済みの機能

✅ 車両情報登録（手動入力・QRスキャン対応）  
✅ 点検項目入力（5区分、コード選択式）  
✅ 写真撮影・管理（Before/After区分設定）  
✅ 交換部品記録（標準部品 + カスタム部品追加機能）  
✅ 測定値入力  
✅ メンテナンスアドバイス  
✅ タグ設定（カンマ区切り）  
✅ 下書き保存・完了  
✅ 整備記録検索（複数条件、タイムライン/テーブル表示）  
✅ 詳細表示画面（参照専用、編集ボタンで編集画面に遷移）  
✅ 顧客専用閲覧ページ（QRコード経由）  
✅ PDF出力（A3モノクロ、QRコード付き）  
✅ RESTful API連携（LocalStorageフォールバック）  
✅ 複数件登録対応（連続登録、一括テスト機能）  
✅ 足回り点検の進捗カウント修正  
✅ データ形式の正規化（タグをJSON文字列化）  
✅ 写真の重複保存防止（更新時に既存写真を削除）  

## 📝 今後の拡張案

### 短期（Phase 2）
- [ ] CSV出力機能（点検履歴・部品交換履歴）
- [ ] 署名機能（整備主任者電子サイン）
- [ ] 写真の圧縮・最適化処理
- [ ] OBD点検項目の追加
- [ ] 車検証QRコード実装（カメラ連携）

### 中期（Phase 3）
- [ ] 顧客管理機能（連絡先・車両履歴）
- [ ] 定期点検リマインダー
- [ ] 統計・分析ダッシュボード
- [ ] 部品在庫管理連携
- [ ] メール送信機能（PDF・QRコード）

### 長期（Phase 4）
- [ ] PWA対応（オフライン動作）
- [ ] 多店舗対応（権限管理）
- [ ] 音声入力対応
- [ ] AI画像診断連携
- [ ] 国交省電子申請連携

## 🧪 複数件登録について

このシステムは複数件の整備記録を問題なく登録・管理できます。

### 動作確認済み
- ✅ 連続して複数の整備記録を作成
- ✅ 各レコードに写真を添付
- ✅ 各レコードに独立したデータを保存
- ✅ LocalStorageとRESTful APIの両方で動作

### テストページ
`test-multiple-records.html` を開くと、複数件登録のテストができます：
- 5件/10件/20件の一括作成
- 作成成功・失敗の統計表示
- 全件取得・削除機能

### 容量制限について
**LocalStorage使用時の制限:**
- ブラウザのLocalStorage容量制限: 約5-10MB
- Base64画像を大量に保存すると容量不足になる可能性
- 推奨: 1レコードあたり写真5枚以内

**RESTful API使用時:**
- サーバー側の制限に依存
- 大量のレコード・写真も問題なく保存可能

## 🐛 既知の制限事項

- 写真は現在Base64形式で保存（大量写真時は容量注意）
- PDF出力は簡易版（本格的なレイアウトは今後実装）
- QRコードスキャンはデモ動作（実装にはライブラリ追加必要）
- ブラウザのカメラ権限が必要
- LocalStorage使用時は容量制限あり（約5-10MB）

## 📞 サポート・お問い合わせ

このシステムはPoC（概念実証）版です。  
本番運用には追加のセキュリティ対策・性能最適化が必要です。

## 📜 ライセンス

このプロジェクトは国土交通省の様式に準拠していますが、  
実際の運用には各事業者の責任において法令遵守を確認してください。

---

**開発日**: 2025-10-24  
**バージョン**: 1.0.0 (PoC)  
**対応様式**: 国土交通省様式 第2号の2（特定整備記録簿）
